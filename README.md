# Compare VI CLI Action

## Overview

This repository hosts the reusable workflows and helper scripts that drive manual
LVCompare runs against commits in a LabVIEW project. The primary entrypoint is the
`Manual VI Compare (refs)` workflow, which walks a branch/ref history, extracts the
target VI at each commit-parent pair, and invokes LVCompare in headless mode.

The latest rev streamlines the workflow inputs so SMEs only need to provide:

1. The branch/tag/commit to inspect (`compare_ref`, defaults to `HEAD`)
2. The repository-relative VI path (`vi_path`)

Additional knobs remain available but defaulted so most runs require no extra
tuning.

## Quick start

### GitHub UI

1. Navigate to **Actions -> Manual VI Compare (refs)**.
2. Click **Run workflow**.
3. Supply `vi_path` (for example `Fixtures/Loop.vi`) and, optionally,
   `compare_ref` if you want something other than the workflow branch tip.
4. Run the workflow. The job summary includes a Markdown table of processed
   pairs, diff counts, and missing entries per mode; any differences raise a
   warning that points at the uploaded diff artifacts.

### CLI (gh)

```powershell
gh workflow run vi-compare-refs.yml `
  -f vi_path='Fixtures/Loop.vi' `
  -f compare_ref='develop'
```

Use `gh run watch <run-id>` or the rendered summary to follow progress. The
workflow uploads two artifacts:

- `vi-compare-manifests` - aggregate suite manifest and per-mode summaries
- `vi-compare-diff-artifacts` - only present when LVCompare detects differences

Each job also emits GitHub outputs pointing at the aggregate manifest, the
history results directory, the per-mode manifest summary (`mode-manifests-json`),
and the generated history report paths (`history-report-md` and, when HTML
renders, `history-report-html`). Downstream workflows and reusable snippets can
consume those keys to surface the Markdown/HTML report or to dispatch follow-up
automation without spelunking the artifacts. When the renderer is unavailable,
`Compare-VIHistory.ps1` writes a lightweight fallback report so the Markdown
output key always resolves to a readable summary.

Provide the optional `notify_issue` input when dispatching the workflow to post
the same summary table to a GitHub issue for stakeholders.

### PR staging helper at a glance

- Comment `/vi-stage` on a pull request (or run `gh workflow run pr-vi-staging.yml -f pr=<number>`).
- The workflow stages VI pairs via `tools/Invoke-PRVIStaging.ps1`, runs LVCompare on each, and posts a summary comment
  with staged/skipped counts, AllowSameLeaf totals, mode breakdown, and LVCompare results. A collapsible table mirrors
  the Markdown summary artifact and is generated by `tools/Summarize-VIStaging.ps1`, so it flags the compare categories
  (front panel, block diagram functional/cosmetic, VI attributes) that triggered for each pair and now includes a
  **Flags** column that lists the LVCompare mode(s) executed and the flag bundle applied.
- Artifacts: `vi-compare-manifest` (manifest + summary) and `vi-compare-staging` (numbered `vi-staging-XX.zip` bundles). Each pairâ€™s `compare/` directory now includes `compare-report.html` plus a `compare-report_files/` folder containing the 2025 LVCompare image assets (set `COMPAREVI_REPORT_FORMAT=html-single` if you need the legacy single-file artifact).
- Labels: successful runs add `vi-staging-ready` (input configurable) and remove it automatically if staging fails or
  finds no pairs.
- Flag overrides: set repository variables `VI_STAGE_COMPARE_FLAGS_MODE` (defaults to `replace`), `VI_STAGE_COMPARE_FLAGS`
  (newline-separated list), and `VI_STAGE_COMPARE_REPLACE_FLAGS` to control LVCompare ignore bundles. Even when filters
  are configured, the workflow also runs an unsuppressed `full` pass so block diagram/front panel edits remain visible;
  both passes and their flag sets appear in the summary's **Flags** column.
- Smoke coverage: `npm run smoke:vi-stage -- --DryRun` prints the plan; `npm run smoke:vi-stage` pushes a scratch branch
  using the baked-in `fixtures/vi-attr` pair so every run produces deterministic LVCompare output.

### Automatic VI compare for fork pull requests

- The `VI Compare (Fork PR)` workflow runs on every pull request that targets `develop`, including forks. The helper
  uses a custom fetch action so the fork head commit is checked out safely, generates a diff manifest, stages pairs,
  runs LVCompare, and uploads compare reports for reviewers.
- The job is read-only (no pushes or release writes) and produces the same artifact layout as `/vi-stage`, giving
  reviewers deterministic bundles without manual staging. The workflow executes on the trusted self-hosted Windows
  runner (`self-hosted, Windows, X64`) so the same LVCompare install used in CI handles fork PRs.
- Manual `/vi-stage` and `/vi-history` dispatches accept a `fetch_depth` input (default `20`) when you need to pull a
  deeper history for local tests.
- To rehearse the fork flow locally, run `pwsh -File tools/Test-ForkSimulation.ps1` in three passes: `-DryRun` shows the
  steps, the default run opens a draft PR and validates the automatic compare job, and `-KeepBranch` preserves the
  scratch branch while the staging/history dispatches finish so you can inspect the artifacts.

## Optional inputs

| Input name                 | Default   | Description                                                                 |
| -------------------------- | --------- | --------------------------------------------------------------------------- |
| `compare_depth`            | `0`       | Maximum commit pairs to evaluate (`0` = no limit)                           |
| `compare_modes`            | `default` | Comma/semicolon list of compare modes (`default,attributes,front-panel`) |
| `compare_ignore_flags`     | `none`    | LVCompare ignore toggles (`none`, `default`, or comma-separated flags)      |
| `compare_additional_flags` | ` `       | Extra LVCompare switches (space-delimited)                                  |
| `compare_fail_fast`        | `false`   | Stop after the first diff                                                   |
| `compare_fail_on_diff`     | `false`   | Fail the workflow when any diff is detected                                 |
| `sample_id`                | _(empty)_ | Optional concurrency key (advanced use)                                     |
| `notify_issue`             | _(empty)_ | Issue number to receive the summary table as a comment                      |

These inputs map directly onto the parameters in `tools/Compare-VIHistory.ps1`,
so advanced behaviour remains available without cluttering the default UX.

## Local helper

You can run the same compare logic locally:

```powershell
pwsh -NoLogo -NoProfile -File tools/Compare-VIHistory.ps1 `
  -TargetPath Fixtures/Loop.vi `
  -StartRef develop `
  -Detailed `
  -RenderReport
```

The helper now processes every reachable commit pair by default. Supply
`-MaxPairs <n>` when you need to cap the history for large or exploratory runs.
Pass `-IncludeMergeParents` to audit merge parents alongside the mainline; the
extra comparisons surface lineage metadata (parent index, branch head, depth)
so reports and manifests call out where each revision originated.

Artifacts are written under `tests/results/ref-compare/history/` using the same
schema as the workflow outputs.

For a quicker end-to-end loop:

- `scripts/Run-VIHistory.ps1` regenerates the history results, prints the
  enriched Markdown summary (including attribute coverage), surfaces the first
  commit pairs it processed, writes `tests/results/ref-compare/history/history-context.json`
  with commit metadata, and renders `tests/results/ref-compare/history/history-report.md`
  (plus `history-report.html` when `-HtmlReport`) so reviewers get a single document
  with author/date context, diff outcome, and relative links to the preserved LVCompare
  report and artifact directory whenever a difference is detected. If the
  renderer throws or is missing, the script falls back to a lightweight Markdown
  stub so downstream tooling still has a report to reference.
- `scripts/Dispatch-VIHistoryWorkflow.ps1` wraps `gh workflow run` and echoes
  the URL to the most recent run so you can follow progress immediately.

Need to point the tools at non-default LabVIEW/LVCompare installs? Copy
`configs/labview-paths.sample.json` to `configs/labview-paths.json` and list any
custom paths under the `lvcompare` and `labview` arrays; the resolvers consult
those entries before falling back to environment variables and canonical Program
Files locations. Run commands with `-Verbose` if you need to inspect the
candidate list while debugging.

## Release and compatibility

Renaming the workflow inputs breaks compatibility with previous revisions, so the
next release should cut a new major tag (for example `v1.0.0`). Update downstream
automation or scheduled triggers to use the new `vi_path` / `compare_ref` inputs
before adopting the release.
