name: "Pester Category Run"
description: "Run Pester tests for a single category with per-category timeouts and Ensure-SessionIndex fallback"
inputs:
  category:
    description: "Category name (dispatcher, fixtures, schema, comparevi, loop, runbook, orchestrator)"
    required: true
  include_integration:
    description: "Include Integration-tagged tests ('true'|'false')"
    required: false
    default: 'true'
  results-dir:
    description: "Results output directory (e.g., tests/results/<category>)"
    required: true
  tests-path:
    description: "Path to tests directory"
    required: false
    default: 'tests'
  default-timeout-seconds:
    description: "Default timeout in seconds when no per-category override is set"
    required: false
    default: '150'
runs:
  using: "composite"
  steps:
    - name: Run Pester tests via local dispatcher (no implicit timeout)
      shell: pwsh
      run: |
        $cat = '${{ inputs.category }}'
        $include = '${{ inputs.include_integration }}'
        if ([string]::IsNullOrWhiteSpace($include)) { $include = 'true' }
        $patterns = @()
        switch ($cat) {
          'dispatcher'   { $patterns = @('Invoke-PesterTests*Tests.ps1','PesterAvailability*Tests.ps1','PesterSummary*Tests.ps1','NestedDispatcher*Tests.ps1','Write-PesterSummaryToStepSummary*Tests.ps1') }
          'fixtures'     { $patterns = @('Fixtures*Tests.ps1','FixtureValidation*Tests.ps1','FixtureSummary.Tests.ps1','ViBinaryHandling.Tests.ps1') }
          'schema'       { $patterns = @('Schema*Tests.ps1','SchemaLite*Tests.ps1') }
          'comparevi'    { $patterns = @('CompareVI*Tests.ps1') }
          'loop'         { $patterns = @('Run-AutonomousIntegrationLoop*Tests.ps1','CompareLoop*Tests.ps1','LoopMetrics.Tests.ps1') }
          'runbook'      { $patterns = @('IntegrationRunbook.Tests.ps1') }
          'orchestrator' { $patterns = @('On-FixtureValidationFail.Tests.ps1','Workflow*Tests.ps1','Guard*Tests.ps1','AggregationHints*Tests.ps1','ArtifactTracking*Tests.ps1','FunctionShadowing*Tests.ps1','Args.Tokenization.Tests.ps1','Action.CompositeOutputs.Tests.ps1') }
          default        { $patterns = @('*.Tests.ps1') }
        }

        # Resolve per-category timeout from env with a default (0 disables inline timeout)
        $timeout = 0
        try { $timeout = [int]'${{ inputs.default-timeout-seconds }}' } catch { $timeout = 0 }
        switch ($cat) {
          'dispatcher'   { $t = $env:PESTER_TIMEOUT_DISPATCHER }
          'fixtures'     { $t = $env:PESTER_TIMEOUT_FIXTURES }
          'schema'       { $t = $env:PESTER_TIMEOUT_SCHEMA }
          'comparevi'    { $t = $env:PESTER_TIMEOUT_COMPAREVI }
          'loop'         { $t = $env:PESTER_TIMEOUT_LOOP }
          'runbook'      { $t = $env:PESTER_TIMEOUT_RUNBOOK }
          'orchestrator' { $t = $env:PESTER_TIMEOUT_ORCHESTRATOR }
        }
        if ($t) { try { $timeout = [int]$t } catch { $timeout = $timeout } }

        $tests   = '${{ inputs.tests-path }}'
        $outDir  = '${{ inputs.results-dir }}'
        if ($cat -eq 'comparevi') {
          $env:PRELOAD_COMPAREVI = '1'
          $env:CI_ALLOW_FAKE_LVCOMPARE = '1'
        }
        $timeoutArgs = @(); if ($timeout -gt 0) { $timeoutArgs = @('-TimeoutSeconds', $timeout) }
        & ./Invoke-PesterTests.ps1 -TestsPath $tests -IncludeIntegration $include -ResultsPath $outDir -IncludePatterns $patterns @timeoutArgs

    - name: Ensure session index (fallback)
      if: always()
      shell: pwsh
      run: |
        $dir = '${{ inputs.results-dir }}'
        pwsh -NonInteractive -File tools/Ensure-SessionIndex.ps1 -ResultsDir $dir -SummaryJson 'pester-summary.json'
