Agent Handoff: Orchestrated CI, Categories, and Dispatch Stabilization

  State summary

  - Orchestrated pipeline restored with category split for Pester:
      - normalize → lint → preflight → pester-category (matrix) → drift → publish.
  - Dispatcher hardened:
      - Invoke-PesterTests.ps1 adds -IncludePatterns/-ExcludePatterns (filters test file list).
      - Determinism composite (iterations=3, interval=0, Exact) wired.
      - Dispatcher profile composite (timeout=150s, emit failures JSON, detect leaks with grace) wired.
  - Summaries improved (job step summaries):
      - Determinism, Runner Identity, Session (session-index.json), Top Failures (from JSON/XML), Artifact Map, Re-run hint.
      - Publish aggregates per-category totals via tools/Summarize-PesterCategories.ps1.
  - Dispatch utilities added:
      - tools/New-SampleId.ps1 (ts‑based IDs by default).
      - tools/Dispatch-WithSample.ps1 (resolves repo + workflow id; dispatches with fallback to REST; prints recent runs).

  Critical fixes applied

  - Removed duplicate jobs and fixed broken needs:
      - drift now needs: [pester-category] (not “pester”).
      - publish now needs: [lint, pester-category, drift].
  - Single definitions for drift and publish kept; no duplicates in ci-orchestrated.yml.

  What likely caused your last “already defined” errors

  - GitHub had a prior version of .github/workflows/ci-orchestrated.yml with two drift/publish blocks. I have re‑normalized the file; commits to develop:
      - b943231 fix(ci): drift needs pester-category (not pester)
      - fab578c fix(ci): restore drift and publish jobs; correct needs
      - f2f8229 add per-category publish summary
      - e2efc68 restore category splits; dispatcher supports patterns

  Verification checklist (do this first)

  1. Confirm orchestrated YAML is current in GitHub:
      - Open Actions → “CI Orchestrated (deterministic chain)”
      - Click “View workflow file” to verify a single drift: and publish: block exist, and drift needs pester-category.
  2. Lint locally:
      - ./bin/actionlint -color (or run Validate workflow).

  How to run (deterministic dispatch)

  - Generate sample_id and dispatch orchestrated on develop:
      - pwsh -File tools/Dispatch-WithSample.ps1 ci-orchestrated.yml -Ref develop -IncludeIntegration true
  - The helper prints:
      - Fresh sample_id
      - Exact gh command used
      - Recent runs list (last 15)
  - If run not visible yet, wait ~10–15 seconds; GitHub sometimes lags after workflow file changes.

  Files you’ll touch

  - .github/workflows/ci-orchestrated.yml (single orchestrated chain; per-category artifacts and publish summary)
  - Invoke-PesterTests.ps1 (pattern filtering and existing config)
  - tools/Dispatch-WithSample.ps1, tools/New-SampleId.ps1 (dispatch)
  - Summaries:
      - tools/Write-DeterminismSummary.ps1
      - tools/Write-RunnerIdentity.ps1
      - tools/Write-SessionIndexSummary.ps1
      - tools/Write-PesterTopFailures.ps1
      - tools/Write-ArtifactMap.ps1
      - tools/Summarize-PesterCategories.ps1

  If dispatch still “does nothing”

  - Confirm workflow name/id resolution:
      - gh workflow list -R <owner/repo> --json name,path,id
      - Ensure “ci-orchestrated.yml” exists and its id appears.
  - Use REST fallback (built into helper). If needed, run manually:
      - gh api repos/<owner>/<repo>/actions/workflows/<id>/dispatches -X POST -F ref=develop -F inputs[sample_id]=<id> -F inputs[include_integration]=true
  - Reopen the workflow file in GH UI to verify it matches the local version (CRLF warnings resolved; GH should parse it fine).

  Category patterns (tune as needed)

  - dispatcher: Invoke-PesterTests*, PesterAvailability*, NestedDispatcher*
  - fixtures: Fixtures., FixtureValidation, FixtureSummary*, ViBinaryHandling*, FixtureValidationDiff*
  - schema: Schema., SchemaLite
  - comparevi: CompareVI*, CanonicalCli, Args.Tokenization
  - loop: CompareLoop*, Run-AutonomousIntegrationLoop*, LoopMetrics, Integration‑ControlLoop*, IntegrationControlLoop*
  - psummary: PesterSummary*, Write-PesterSummaryToStepSummary*, AggregationHints*
  - workflow: Workflow*, On‑FixtureValidationFail, Watch.FlakyRecovery, FunctionShadowing*, FunctionProxy, RunSummary.Tool*, Action.CompositeOutputs,
  Binding.MinRepro, ArtifactTracking*, Guard.*

  Next steps (plan)

  1. Trigger ci-orchestrated on develop via tools/Dispatch-WithSample.ps1 and wait for publish.
  2. Verify publish summary shows per-category lines (status, totals, duration).
  3. Adjust IncludePatterns/ExcludePatterns if flakiness/noise discovered; re-run categories.
  4. If dispatch visibility is still intermittent, I can add a poller to the Dispatch-WithSample helper to wait until the new run appears and output the run URL.

  Troubleshooting

  - “drift already defined / publish already defined”:
      - Confirm only one drift: and publish: appear in ci-orchestrated.yml (search by ‘^drift:’ or ‘^publish:’).
  - “depends on unknown job 'pester'”:
      - Replace any needs: [pester] with needs: [pester-category].
  - gh CLI errors (view --json unsupported):
      - The helper no longer relies on view --json; it uses list + ConvertFrom-Json.