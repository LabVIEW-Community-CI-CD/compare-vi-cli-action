{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://labview-community-ci-cd.github.io/schemas/session-index-v1.schema.json",
  "title": "Session Index v1",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema", "schemaVersion", "generatedAtUtc", "resultsDir", "files"],
  "properties": {
    "schema": { "const": "session-index/v1" },
    "schemaVersion": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
    "generatedAtUtc": { "type": "string", "format": "date-time" },
    "resultsDir": { "type": "string" },
    "includeIntegration": { "type": "boolean" },
    "integrationMode": {
      "anyOf": [
        { "type": "string", "enum": ["include", "exclude", "auto"] },
        { "type": "null" }
      ]
    },
    "integrationSource": { "type": ["string", "null"] },
    "status": { "type": "string", "enum": ["ok", "fail"] },
    "files": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pesterResultsXml": { "type": "string" },
        "pesterSummaryTxt": { "type": "string" },
        "pesterSummaryJson": { "type": "string" },
        "pesterFailuresJson": { "type": "string" },
        "artifactManifestJson": { "type": "string" },
        "artifactTrailJson": { "type": "string" },
        "leakReportJson": { "type": "string" },
        "compareReportHtml": { "type": "string" },
        "resultsIndexHtml": { "type": "string" }
      }
    },
    "summary": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "total": { "type": "integer", "minimum": 0 },
        "passed": { "type": "integer", "minimum": 0 },
        "failed": { "type": "integer", "minimum": 0 },
        "errors": { "type": "integer", "minimum": 0 },
        "skipped": { "type": "integer", "minimum": 0 },
        "duration_s": { "type": "number", "minimum": 0 },
        "meanTest_ms": { "type": ["number", "null"], "minimum": 0 },
        "p95Test_ms": { "type": ["number", "null"], "minimum": 0 },
        "maxTest_ms": { "type": ["number", "null"], "minimum": 0 },
        "schemaVersion": { "type": "string" }
      }
    },
    "drift": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "latestRunDir": { "type": "string" },
        "latestSummary": { "type": ["string", "null"] },
        "status": { "type": ["string", "null"] }
      }
    },
    "runContext": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "repository": { "type": ["string", "null"] },
        "ref": { "type": ["string", "null"] },
        "commitSha": { "type": ["string", "null"] },
        "workflow": { "type": ["string", "null"] },
        "runId": { "type": ["string", "null"] },
        "runAttempt": { "type": ["string", "null"] },
        "job": { "type": ["string", "null"] },
        "runner": { "type": ["string", "null"] },
        "runnerOS": { "type": ["string", "null"] },
        "runnerArch": { "type": ["string", "null"] },
        "runnerEnvironment": { "type": ["string", "null"] },
        "runnerMachine": { "type": ["string", "null"] },
        "runnerTrackingId": { "type": ["string", "null"] },
        "runnerImageOS": { "type": ["string", "null"] },
        "runnerImageVersion": { "type": ["string", "null"] },
        "runnerLabels": {
          "type": ["array", "null"],
          "items": { "type": "string" }
        }
      }
    },
    "urls": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "repository": { "type": "string", "format": "uri" },
        "run": { "type": ["string", "null"], "format": "uri" },
        "commit": { "type": ["string", "null"], "format": "uri" },
        "pullRequest": { "type": ["string", "null"], "format": "uri" }
      }
    },
    "watchers": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "rest": {
          "type": "object",
          "additionalProperties": false,
          "required": ["schema", "repo", "runId", "polledAtUtc", "jobs"],
          "properties": {
            "schema": { "const": "ci-watch/rest-v1" },
            "repo": { "type": "string" },
            "runId": { "type": "integer", "minimum": 1 },
            "branch": { "type": ["string", "null"] },
            "headSha": { "type": ["string", "null"] },
            "status": { "type": ["string", "null"] },
            "conclusion": { "type": ["string", "null"] },
            "htmlUrl": { "type": ["string", "null"], "format": "uri" },
            "displayTitle": { "type": ["string", "null"] },
            "polledAtUtc": { "type": "string", "format": "date-time" },
            "jobs": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["id", "name", "status"],
                "properties": {
                  "id": { "type": "integer", "minimum": 1 },
                  "name": { "type": "string" },
                  "status": { "type": "string" },
                  "conclusion": { "type": ["string", "null"] },
                  "htmlUrl": { "type": ["string", "null"], "format": "uri" }
                }
              }
            }
          }
        }
      }
    },
    "stepSummary": { "type": "string" },
    "branchProtection": {
      "type": "object",
      "additionalProperties": false,
      "required": ["contract", "branch", "expected", "produced", "actual", "result", "tags"],
      "properties": {
        "contract": {
          "type": "object",
          "additionalProperties": false,
          "required": ["id", "version", "issue", "mappingPath", "mappingDigest"],
          "properties": {
            "id": { "type": "string" },
            "version": { "type": "string" },
            "issue": { "type": "integer", "minimum": 1 },
            "mappingPath": { "type": "string" },
            "mappingDigest": { "type": "string" }
          }
        },
        "branch": { "type": "string" },
        "expected": {
          "type": "array",
          "items": { "type": "string" }
        },
        "produced": {
          "type": "array",
          "items": { "type": "string" }
        },
        "actual": {
          "type": "object",
          "additionalProperties": false,
          "required": ["status"],
          "properties": {
            "status": { "type": "string", "enum": ["available", "unavailable", "error"] },
            "contexts": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "result": {
          "type": "object",
          "additionalProperties": false,
          "required": ["status", "reason"],
          "properties": {
            "status": { "type": "string", "enum": ["ok", "warn", "fail"] },
            "reason": {
              "type": "string",
              "enum": [
                "aligned",
                "missing_required",
                "extra_required",
                "mismatch",
                "mapping_missing",
                "api_unavailable",
                "api_error"
              ]
            }
          }
        },
        "notes": {
          "type": "array",
          "items": { "type": "string" }
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  }
}
